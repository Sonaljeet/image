Sub DownloadPDFsToFolders()
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Sheets(1) ' Change if needed

    Dim lastRow As Long, lastCol As Long
    Dim url1 As String, url2 As String
    Dim rowFolderPath As String
    Dim baseFolder As String
    Dim i As Long
    Dim fileName2 As String
    Dim latestPDF As String

    ' Set base download folder
    baseFolder = ThisWorkbook.Path & "\PDF_Downloads"

    ' Create base folder if not exists
    If Dir(baseFolder, vbDirectory) = "" Then MkDir baseFolder

    ' Get last row and last two columns
    lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column

    For i = 2 To lastRow ' Assuming header in row 1
        url1 = Trim(ws.Cells(i, lastCol - 1).Value)
        url2 = Trim(ws.Cells(i, lastCol).Value)

        ' Create folder for the current row
        rowFolderPath = baseFolder & "\Row_" & i
        If Dir(rowFolderPath, vbDirectory) = "" Then MkDir rowFolderPath

        ' === Handle URL1 - assumed to download via browser ===
        If url1 <> "" Then
            ' Open the URL in browser
            ThisWorkbook.FollowHyperlink url1

            ' Wait a few seconds for the file to download
            Application.Wait Now + TimeValue("0:00:05") ' Adjust time if needed

            ' Get latest PDF from Downloads folder
            latestPDF = GetLatestDownloadedPDF()
            If latestPDF <> "" Then
                FileCopy latestPDF, rowFolderPath & "\" & Dir(latestPDF)
            Else
                Debug.Print "No recent PDF found in Downloads."
            End If
        End If

        ' === Handle URL2 - download via HTTP request ===
        If url2 <> "" Then
            fileName2 = GetFileNameFromURL(url2)
            DownloadFile url2, rowFolderPath & "\" & fileName2
        End If
    Next i

    MsgBox "PDF downloads completed!"
End Sub

' Download file using HTTP request
Sub DownloadFile(ByVal fileURL As String, ByVal savePath As String)
    Dim WinHttpReq As Object
    Set WinHttpReq = CreateObject("Microsoft.XMLHTTP")
    
    On Error GoTo ErrorHandler
    WinHttpReq.Open "GET", fileURL, False
    WinHttpReq.Send

    If WinHttpReq.Status = 200 Then
        Dim oStream As Object
        Set oStream = CreateObject("ADODB.Stream")
        oStream.Type = 1 ' Binary
        oStream.Open
        oStream.Write WinHttpReq.responseBody
        oStream.SaveToFile savePath, 2 ' Overwrite
        oStream.Close
    End If

    Exit Sub

ErrorHandler:
    Debug.Print "Error downloading: " & fileURL
End Sub

' Extract filename from URL
Function GetFileNameFromURL(fileURL As String) As String
    Dim parts() As String
    parts = Split(fileURL, "/")
    GetFileNameFromURL = parts(UBound(parts))
End Function

' Get the most recent PDF from Downloads folder
Function GetLatestDownloadedPDF() As String
    Dim downloadFolder As String
    Dim fileName As String
    Dim latestFile As String
    Dim latestDate As Date

    downloadFolder = Environ("USERPROFILE") & "\Downloads"
    fileName = Dir(downloadFolder & "\*.pdf")

    Do While fileName <> ""
        If FileDateTime(downloadFolder & "\" & fileName) > latestDate Then
            latestDate = FileDateTime(downloadFolder & "\" & fileName)
            latestFile = downloadFolder & "\" & fileName
        End If
        fileName = Dir
    Loop

    GetLatestDownloadedPDF = latestFile
End Function
