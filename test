Sub DownloadFilesToFolders()
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Sheets(1)

    Dim lastRow As Long, lastCol As Long
    Dim url1 As String, url2 As String
    Dim fileExt As String
    Dim rowFolderPath As String
    Dim baseFolder As String
    Dim destPath As String
    Dim i As Long

    baseFolder = ThisWorkbook.Path & "\PDF_Downloads"
    If Dir(baseFolder, vbDirectory) = "" Then MkDir baseFolder

    lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column

    For i = 2 To lastRow
        url1 = Trim(ws.Cells(i, lastCol - 1).Value)
        url2 = Trim(ws.Cells(i, lastCol).Value)

        rowFolderPath = baseFolder & "\Row_" & i
        If Dir(rowFolderPath, vbDirectory) = "" Then MkDir rowFolderPath

        ' Download and process url1
        If url1 <> "" Then
            fileExt = GetExtensionFromURLResponse(url1)
            If fileExt = "" Then fileExt = ".bin"
            destPath = rowFolderPath & "\file1" & fileExt
            DownloadFile url1, destPath
            If LCase(fileExt) = ".doc" Or LCase(fileExt) = ".docx" Then
                ConvertWordToPDF destPath, Replace(destPath, fileExt, ".pdf")
                Kill destPath ' Delete Word file after conversion
            End If
        End If

        ' Download and process url2
        If url2 <> "" Then
            fileExt = GetFileExtensionFromURL(url2)
            destPath = rowFolderPath & "\file2" & fileExt
            DownloadFile url2, destPath
            If LCase(fileExt) = ".doc" Or LCase(fileExt) = ".docx" Then
                ConvertWordToPDF destPath, Replace(destPath, fileExt, ".pdf")
                Kill destPath ' Delete Word file after conversion
            End If
        End If
    Next i

    MsgBox "Download and conversion completed!"
End Sub

Sub ConvertWordToPDF(docPath As String, pdfPath As String)
    On Error GoTo ErrorHandler
    Dim wdApp As Object, wdDoc As Object
    Set wdApp = CreateObject("Word.Application")
    wdApp.Visible = False

    Set wdDoc = wdApp.Documents.Open(docPath, ReadOnly:=True)
    wdDoc.ExportAsFixedFormat OutputFileName:=pdfPath, ExportFormat:=17
    wdDoc.Close False
    wdApp.Quit

    Set wdDoc = Nothing
    Set wdApp = Nothing
    Exit Sub

ErrorHandler:
    MsgBox "Failed to convert Word to PDF: " & docPath
    If Not wdApp Is Nothing Then wdApp.Quit
End Sub
