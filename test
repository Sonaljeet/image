Sub MoveLatestDownloadedFilesToRowFolders()
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Sheets(1)

    Dim lastRow As Long, lastCol As Long
    Dim rowFolderPath As String, baseFolder As String
    Dim downloadsPath As String
    Dim latestFile As String, fileExt As String
    Dim sourcePath As String, destPath As String
    Dim i As Long

    downloadsPath = Environ$("USERPROFILE") & "\Downloads\"
    baseFolder = ThisWorkbook.Path & "\PDF_Downloads"
    If Dir(baseFolder, vbDirectory) = "" Then MkDir baseFolder

    lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    lastCol = ws.Cells(1, ws.Columns.Count).End(xlToLeft).Column

    For i = 2 To lastRow
        rowFolderPath = baseFolder & "\Row_" & i
        If Dir(rowFolderPath, vbDirectory) = "" Then MkDir rowFolderPath

        ' Wait for a new file to appear in Downloads (20 seconds timeout)
        latestFile = WaitForLatestFile(downloadsPath, 20)
        If latestFile = "" Then
            MsgBox "No new file found in Downloads for Row " & i, vbExclamation
            GoTo ContinueLoop
        End If

        sourcePath = downloadsPath & latestFile
        fileExt = GetFileExtension(latestFile)
        destPath = rowFolderPath & "\file1" & fileExt

        ' Copy file from Downloads to Row_i folder
        FileCopy sourcePath, destPath

        ' Optional: delete original from Downloads after copy
        ' Kill sourcePath

        ' Convert Word docs to PDF and delete original Word file
        If LCase(fileExt) = ".doc" Or LCase(fileExt) = ".docx" Then
            ConvertWordToPDF destPath, Replace(destPath, fileExt, ".pdf")
            Kill destPath
        End If

ContinueLoop:
    Next i

    MsgBox "Files moved and converted where needed!"
End Sub

' Waits for a file to appear in the folder and returns the newest file name or "" if timeout
Function WaitForLatestFile(folderPath As String, timeoutSeconds As Integer) As String
    Dim startTime As Single
    Dim fso As Object
    Dim folder As Object
    Dim file As Object
    Dim latestFileName As String
    Dim latestDate As Date

    Set fso = CreateObject("Scripting.FileSystemObject")
    Set folder = fso.GetFolder(folderPath)

    startTime = Timer
    Do
        latestDate = #1/1/1900#
        latestFileName = ""

        For Each file In folder.Files
            If file.DateLastModified > latestDate Then
                latestDate = file.DateLastModified
                latestFileName = file.Name
            End If
        Next

        If latestFileName <> "" Then
            WaitForLatestFile = latestFileName
            Exit Function
        End If

        DoEvents
        If Timer - startTime > timeoutSeconds Then Exit Do
        Application.Wait Now + TimeValue("0:00:01") ' Wait 1 second
    Loop

    WaitForLatestFile = ""
End Function

Function GetFileExtension(fileName As String) As String
    If InStrRev(fileName, ".") > 0 Then
        GetFileExtension = Mid(fileName, InStrRev(fileName, "."))
    Else
        GetFileExtension = ""
    End If
End Function

Sub ConvertWordToPDF(docPath As String, pdfPath As String)
    On Error GoTo ErrorHandler
    Dim wdApp As Object, wdDoc As Object
    Set wdApp = CreateObject("Word.Application")
    wdApp.Visible = False

    Set wdDoc = wdApp.Documents.Open(docPath, ReadOnly:=True)
    wdDoc.ExportAsFixedFormat OutputFileName:=pdfPath, ExportFormat:=17
    wdDoc.Close False
    wdApp.Quit

    Set wdDoc = Nothing
    Set wdApp = Nothing
    Exit Sub

ErrorHandler:
    MsgBox "Error converting Word to PDF: " & docPath
    If Not wdApp Is Nothing Then wdApp.Quit
End Sub
